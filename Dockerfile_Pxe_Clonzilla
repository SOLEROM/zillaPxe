###############################################################################
# Stage 1  –  common-base (shared bits)
###############################################################################
FROM ubuntu:22.04 AS common-base

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Etc/UTC \
    PATH="/home/user/.local/bin:${PATH}"

# ---- base packages ----------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        sudo docker.io tzdata iputils-ping \
        software-properties-common ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ---- unprivileged user with passwordless sudo -------------------------------
RUN useradd -m -s /bin/bash user && \
    echo "user ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/user && \
    chmod 0440 /etc/sudoers.d/user

# ---- shared directory -------------------------------------------------------
RUN mkdir -p /home/user/shared && chown -R user:user /home/user/shared

WORKDIR /home/user
USER    user

###############################################################################
# Stage 2  –  final image: PXE + dnsmasq + SSH + NFSv4
###############################################################################
FROM common-base AS final

ARG MEMTEST_VERSION=5.31b
ARG SYSLINUX_VERSION=6.03
ENV TEMP_SYSLINUX_PATH=/tmp/syslinux-${SYSLINUX_VERSION}

USER root

# ---- extra packages ---------------------------------------------------------
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        vim wget \
        dnsmasq \
        openssh-server \
        nfs-kernel-server rpcbind \
    && rm -rf /var/lib/apt/lists/*

# ---- OpenSSH setup ----------------------------------------------------------
RUN echo 'root:root' | chpasswd && \
    sed -Ei 's/^#?PermitRootLogin .*/PermitRootLogin yes/'  /etc/ssh/sshd_config && \
    sed -Ei 's/^#?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    mkdir -p /var/run/sshd && \
    ssh-keygen -A                 # generate host keys at build time

# ---- NFS export -------------------------------------------------------------
RUN mkdir -p /home/nfs && chown nobody:nogroup /home/nfs && \
    echo '/home/nfs *(rw,sync,no_subtree_check,insecure,fsid=0,no_root_squash)' > /etc/exports

# ---- download + install Syslinux PXE pieces & Memtest -----------------------
WORKDIR /tmp
RUN set -e; \
    mkdir -p "${TEMP_SYSLINUX_PATH}" && \
    wget -q "https://www.kernel.org/pub/linux/utils/boot/syslinux/syslinux-${SYSLINUX_VERSION}.tar.gz" && \
    tar -xzf "syslinux-${SYSLINUX_VERSION}.tar.gz" && \
    mkdir -p /var/lib/tftpboot && \
    cp ${TEMP_SYSLINUX_PATH}/bios/core/pxelinux.0                    /var/lib/tftpboot/ && \
    cp ${TEMP_SYSLINUX_PATH}/bios/com32/libutil/libutil.c32          /var/lib/tftpboot/ && \
    cp ${TEMP_SYSLINUX_PATH}/bios/com32/elflink/ldlinux/ldlinux.c32  /var/lib/tftpboot/ && \
    cp ${TEMP_SYSLINUX_PATH}/bios/com32/menu/menu.c32                /var/lib/tftpboot/ && \
    rm -rf "${TEMP_SYSLINUX_PATH}" "syslinux-${SYSLINUX_VERSION}.tar.gz" && \
    wget -q "http://www.memtest.org/download/archives/${MEMTEST_VERSION}/memtest86+-${MEMTEST_VERSION}.bin.gz" && \
    gzip -d "memtest86+-${MEMTEST_VERSION}.bin.gz" && \
    mkdir -p /var/lib/tftpboot/memtest && \
    mv "memtest86+-${MEMTEST_VERSION}.bin" /var/lib/tftpboot/memtest/memtest86+

# ---- copy local configuration & banner --------------------------------------
COPY tftpboot/ /var/lib/tftpboot/
COPY etc/      /etc/
COPY welcome   /

# display banner in any interactive shell
RUN echo '[[ $- == *i* ]] && cat /welcome' >> /etc/bash.bashrc

# ---- entrypoint -------------------------------------------------------------
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
# ENTRYPOINT ["docker-entrypoint.sh"]

# ---- default command = foreground sshd --------------------------------------
CMD ["/usr/sbin/sshd", "-D"]

# ---- ports: SSH (22), NFS (2049) + rpcbind (111), PXE (67,69) ---------------
EXPOSE 22 2049 111 67/udp 69/udp
