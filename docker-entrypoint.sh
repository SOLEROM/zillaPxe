#!/usr/bin/env bash
set -e

# ---------------------------------------------------------------------------
# 0. Make sure required runtime dirs exist
# ---------------------------------------------------------------------------
mkdir -p /var/run/sshd  /run/rpcbind  /proc/fs/nfsd

# ---------------------------------------------------------------------------
# 1. rpcbind  (needed for idmapd + legacy tools)
# ---------------------------------------------------------------------------
rpcbind -w

# ---------------------------------------------------------------------------
# 2. nfsd kernel threads — start *before* exportfs so the procfs is ready
#    -G 15  ==> 15 nfsd threads (adjust to workload)
# ---------------------------------------------------------------------------
rpc.nfsd -G 15       # autoloads 'nfsd' module on host if not already loaded

# ---------------------------------------------------------------------------
# 3. Exports table -> kernel
# ---------------------------------------------------------------------------
exportfs -r          # now succeeds because /proc/fs/nfsd is mounted

# ---------------------------------------------------------------------------
# 4. UID/GID ↔︎ name mapper (only for NFSv4)
# ---------------------------------------------------------------------------
rpc.idmapd -f &

# ---------------------------------------------------------------------------
# 5. dnsmasq for DHCP/TFTP/PXE (optional: only start if not running)
# ---------------------------------------------------------------------------
if ! pgrep -x dnsmasq >/dev/null 2>&1; then
  dnsmasq -k --log-facility=- &
fi

# ---------------------------------------------------------------------------
# 6. Hand off to whatever CMD was given (default: sshd -D)
# ---------------------------------------------------------------------------
exec "$@"
